#!/bin/bash

# Variables
ELASTIC_PASSWORD="${ELASTIC_PASSWORD:-ZvSzbUsSY9yDKx4U2AvVZ8NZI4XIGWnt}"

echo "üß™ Tests de connexion SSL √† Elasticsearch..."

# Attendre que le service soit pr√™t
echo "‚è≥ Attente du d√©marrage d'Elasticsearch..."
sleep 30

# Test 1: Connexion sans SSL (pour debug)
echo "Test 1: V√©rification que le port 9200 r√©pond..."
curl -m 10 -s http://localhost:9200 || echo "‚ùå HTTP non disponible (normal si SSL activ√©)"

# Test 2: Connexion SSL sans v√©rification de certificat
echo "Test 2: Connexion SSL sans v√©rification..."
curl -k -m 10 -s -u elastic:$ELASTIC_PASSWORD https://localhost:9200 || echo "‚ùå SSL sans v√©rification √©chou√©"

# Test 3: Connexion SSL avec CA
echo "Test 3: Connexion SSL avec CA..."
curl -m 10 -s --cacert certs/ca/ca.crt -u elastic:$ELASTIC_PASSWORD https://localhost:9200 || echo "‚ùå SSL avec CA √©chou√©"

# Test 4: Connexion SSL compl√®te (si n√©cessaire)
echo "Test 4: Connexion SSL avec certificat client..."
curl -m 10 -s \
  --cacert certs/ca/ca.crt \
  --cert certs/elasticsearch/elasticsearch.crt \
  --key certs/elasticsearch/elasticsearch.key \
  -u elastic:$ELASTIC_PASSWORD \
  https://localhost:9200 || echo "‚ùå SSL complet √©chou√©"

# Test 5: Diagnostic du certificat
echo "Test 5: Diagnostic du certificat..."
echo | openssl s_client -connect localhost:9200 -servername localhost 2>/dev/null | openssl x509 -noout -subject -issuer -dates || echo "‚ùå Impossible de r√©cup√©rer le certificat du serveur"

# Test 6: V√©rification interne du container
echo "Test 6: Test depuis l'int√©rieur du container..."
docker exec elasticsearch curl -k -s https://localhost:9200 || echo "‚ùå Test interne √©chou√©"

# Affichage des logs r√©cents
echo "üìã Logs r√©cents d'Elasticsearch:"
docker logs elasticsearch --tail 20

echo ""
echo "üîß COMMANDES DE DEBUG SUPPL√âMENTAIRES:"
echo "1. V√©rifier les logs: docker logs elasticsearch"
echo "2. Acc√©der au container: docker exec -it elasticsearch bash"
echo "3. V√©rifier la config: docker exec elasticsearch cat /usr/share/elasticsearch/config/elasticsearch.yml"
echo "4. Lister les certificats: docker exec elasticsearch ls -la /usr/share/elasticsearch/config/certs/"
