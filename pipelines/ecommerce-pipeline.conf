input {
  file {
    path => "/path/to/ecommerce_transactions.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "plain"
    tags => ["ecommerce", "csv"]
  }
}

filter {
  # Découpage du CSV
  csv {
    separator => ","
    columns => ["transaction_id", "timestamp", "customer_id", "product_id", "product_name", "quantity", "price", "payment_method", "country", "city", "rating"]
    convert => {
      "quantity" => "integer"
      "price" => "float"
      "rating" => "integer"
    }
  }

  # Conversion du timestamp
  date {
    match => ["timestamp", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
    timezone => "UTC"
  }

  # Suppression du champ original
  mutate {
    remove_field => ["timestamp"]
  }

  # Enrichissement des données
  translate {
    field => "country"
    destination => "country_name"
    dictionary => {
      "USA" => "United States"
      "UK" => "United Kingdom"
      "Canada" => "Canada"
    }
    override => true
  }

  # Calcul du montant total
  ruby {
    code => "event.set('total_amount', event.get('quantity') * event.get('price'))"
  }

  # Classification des produits
  if [product_name] =~ /Laptop|Smartphone/ {
    mutate {
      add_field => { "product_category" => "Electronics" }
    }
  } else if [product_name] =~ /Headphones|Speaker/ {
    mutate {
      add_field => { "product_category" => "Audio" }
    }
  } else {
    mutate {
      add_field => { "product_category" => "Other" }
    }
  }

  # Suppression des événements invalides
  if [transaction_id] == "" or [customer_id] == "" {
    drop {}
  }
}

output {
  elasticsearch {
    hosts => ["https://elasticsearch:9200"]
    index => "ecommerce-transactions-%{+YYYY.MM.dd}"
    user => "elastic"
    password => "votre_mot_de_passe"
    ssl_certificate_verification => true
    cacert => "/path/to/http_ca.crt"
    template => "/path/to/ecommerce-template.json"
    template_name => "ecommerce-template"
    template_overwrite => true
  }

  # Output pour le débogage (optionnel)
  stdout {
    codec => rubydebug
  }
}
